@{
    ViewData["Title"] = "Book Train Ticket";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<style>
    .book-ride-section {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 80px 0;
        min-height: 100vh;
    }

    .booking-container {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        padding: 50px;
        margin-bottom: 30px;
    }

    .booking-header {
        text-align: center;
        margin-bottom: 40px;
    }

    .booking-header h2 {
        color: #333;
        font-size: 36px;
        font-weight: 700;
        margin-bottom: 15px;
        background: linear-gradient(135deg, #667eea, #764ba2);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .booking-header p {
        color: #666;
        font-size: 18px;
        margin: 0;
        line-height: 1.6;
    }

    .booking-form {
        max-width: 800px;
        margin: 0 auto;
    }

    .form-section {
        background: #f8f9fa;
        border-radius: 15px;
        padding: 30px;
        margin-bottom: 30px;
        border-left: 4px solid #667eea;
    }

    .section-title {
        color: #333;
        font-size: 20px;
        font-weight: 600;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
    }

    .section-title i {
        margin-right: 10px;
        color: #667eea;
    }

    .form-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
    }

    .form-group {
        position: relative;
    }

    .form-group label {
        display: block;
        margin-bottom: 8px;
        color: #333;
        font-weight: 600;
        font-size: 14px;
    }

    .form-group input,
    .form-group select {
        width: 100%;
        padding: 15px 20px;
        border: 2px solid #e1e5e9;
        border-radius: 12px;
        font-size: 16px;
        transition: all 0.3s ease;
        background: #fff;
    }

    .form-group input:focus,
    .form-group select:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .form-group select {
        width: 100%;
        padding: 15px 20px;
        border: 2px solid #e1e5e9;
        border-radius: 12px;
        font-size: 16px;
        transition: all 0.3s ease;
        background: #fff;
        cursor: pointer;
    }

    .form-group select:disabled {
        background: #f8f9fa;
        cursor: not-allowed;
        opacity: 0.6;
    }

    .form-group .input-icon {
        position: absolute;
        right: 15px;
        top: 50%;
        transform: translateY(-50%);
        color: #999;
        font-size: 18px;
    }

    .submit-btn {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        border: none;
        padding: 18px 40px;
        border-radius: 25px;
        font-size: 18px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        width: 100%;
        margin-top: 20px;
    }

    .submit-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
    }

    .submit-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }

    .alert {
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 20px;
        font-weight: 500;
    }

    .alert-success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }

    .alert-danger {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }

    .booking-result {
        background: #fff;
        border-radius: 15px;
        padding: 30px;
        margin-top: 30px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        display: none;
    }

    .booking-result.show {
        display: block;
        animation: slideIn 0.5s ease;
    }

    @@keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .result-header {
        text-align: center;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 2px solid #f0f0f0;
    }

    .result-header h3 {
        color: #333;
        font-size: 24px;
        font-weight: 700;
        margin-bottom: 10px;
    }

    .booking-code {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        padding: 15px 30px;
        border-radius: 25px;
        font-size: 20px;
        font-weight: 700;
        display: inline-block;
        margin: 10px 0;
        letter-spacing: 2px;
    }

    .qr-code-container {
        text-align: center;
        margin: 30px 0;
    }

    .qr-code {
        max-width: 200px;
        margin: 0 auto;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 15px;
        border: 2px dashed #ddd;
    }

    .booking-details {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin: 30px 0;
    }

    .detail-item {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 10px;
        border-left: 4px solid #667eea;
    }

    .detail-label {
        font-size: 12px;
        color: #666;
        text-transform: uppercase;
        font-weight: 600;
        margin-bottom: 5px;
    }

    .detail-value {
        font-size: 16px;
        color: #333;
        font-weight: 600;
    }

    .loading-spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: #fff;
        animation: spin 1s ease-in-out infinite;
    }

    @@keyframes spin {
        to { transform: rotate(360deg); }
    }

    .floating-shapes {
        position: absolute;
        width: 100%;
        height: 100%;
        overflow: hidden;
        z-index: -1;
    }

    .shape {
        position: absolute;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 50%;
        animation: float 6s ease-in-out infinite;
    }

    .shape:nth-child(1) {
        width: 80px;
        height: 80px;
        top: 20%;
        left: 10%;
        animation-delay: 0s;
    }

    .shape:nth-child(2) {
        width: 120px;
        height: 120px;
        top: 60%;
        right: 10%;
        animation-delay: 2s;
    }

    .shape:nth-child(3) {
        width: 60px;
        height: 60px;
        bottom: 20%;
        left: 20%;
        animation-delay: 4s;
    }

    @@keyframes float {
        0%, 100% { transform: translateY(0px) rotate(0deg); }
        50% { transform: translateY(-20px) rotate(180deg); }
    }
</style>

<section class="book-ride-section">
    <div class="floating-shapes">
        <div class="shape"></div>
        <div class="shape"></div>
        <div class="shape"></div>
    </div>

    <div class="container">
        <div class="booking-container">
            <div class="booking-header">
                <h2><i class="fa fa-train"></i> Book Your Train Ticket</h2>
                <p>Fast, secure, and convenient train booking for your journey</p>
            </div>

            <div id="alert-container"></div>

            <form id="bookingForm" class="booking-form">
                <div class="form-section">
                    <div class="section-title">
                        <i class="fa fa-user"></i> Passenger Information
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="passengerName">Full Name *</label>
                            <input type="text" id="passengerName" name="passengerName" required placeholder="Enter your full name">
                            <i class="fa fa-user input-icon"></i>
                        </div>
                        <div class="form-group">
                            <label for="passengerPhone">Phone Number *</label>
                            <input type="tel" id="passengerPhone" name="passengerPhone" required placeholder="Enter your phone number">
                            <i class="fa fa-phone input-icon"></i>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="passengerEmail">Email Address *</label>
                            <input type="email" id="passengerEmail" name="passengerEmail" required placeholder="Enter your email">
                            <i class="fa fa-envelope input-icon"></i>
                        </div>
                        <div class="form-group">
                            <label for="passengerIdCard">ID Card Number</label>
                            <input type="text" id="passengerIdCard" name="passengerIdCard" placeholder="Enter your ID card number">
                            <i class="fa fa-id-card input-icon"></i>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <div class="section-title">
                        <i class="fa fa-train"></i> Trip Information
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="tripId">Select Trip *</label>
                            <select id="tripId" name="tripId" required>
                                <option value="">Choose a trip...</option>
                            </select>
                            <i class="fa fa-train input-icon"></i>
                        </div>
                        <div class="form-group">
                            <label for="seatId">Select Seat *</label>
                            <select id="seatId" name="seatId" required disabled>
                                <option value="">Choose a seat...</option>
                            </select>
                            <i class="fa fa-chair input-icon"></i>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <div class="section-title">
                        <i class="fa fa-info-circle"></i> Additional Information
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="passengerDateOfBirth">Date of Birth</label>
                            <input type="date" id="passengerDateOfBirth" name="passengerDateOfBirth">
                            <i class="fa fa-calendar input-icon"></i>
                        </div>
                        <div class="form-group">
                            <label for="contactName">Contact Person Name</label>
                            <input type="text" id="contactName" name="contactName" placeholder="Emergency contact name">
                            <i class="fa fa-user-plus input-icon"></i>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="contactPhone">Contact Person Phone</label>
                            <input type="tel" id="contactPhone" name="contactPhone" placeholder="Emergency contact phone">
                            <i class="fa fa-phone-square input-icon"></i>
                        </div>
                        <div class="form-group">
                            <label for="contactEmail">Contact Person Email</label>
                            <input type="email" id="contactEmail" name="contactEmail" placeholder="Emergency contact email">
                            <i class="fa fa-envelope-o input-icon"></i>
                        </div>
                    </div>
                </div>

                <button type="submit" class="submit-btn" id="submitBtn">
                    <span class="btn-text">Book Ticket Now</span>
                </button>
            </form>

            <div class="booking-result" id="bookingResult">
                <div class="result-header">
                    <h3><i class="fa fa-check-circle"></i> Booking Successful!</h3>
                    <p>Your ticket has been booked successfully. Please save your booking information.</p>
                </div>

                <div style="text-align: center; margin: 30px 0;">
                    <div class="booking-code" id="bookingCode">GB20241201123456</div>
                    <p style="color: #666; margin-top: 10px;">Your Booking Code</p>
                </div>

                <div class="qr-code-container">
                    <h4>QR Code for Boarding</h4>
                    <div class="qr-code" id="qrCode">
                        <img id="qrCodeImage" src="" alt="QR Code" style="max-width: 100%;">
                    </div>
                    <p style="color: #666; margin-top: 10px;">Show this QR code to staff for boarding</p>
                </div>

                <div class="booking-details" id="bookingDetails">
                    <!-- Booking details will be populated here -->
                </div>

                <div style="text-align: center; margin-top: 30px;">
                    <button class="submit-btn" onclick="resetForm()" style="width: auto; margin: 10px;">
                        <i class="fa fa-plus"></i> Book Another Ticket
                    </button>
                    <button class="submit-btn" onclick="printTicket()" style="width: auto; margin: 10px; background: linear-gradient(135deg, #28a745, #20c997);">
                        <i class="fa fa-print"></i> Print Ticket
                    </button>
                </div>
            </div>
        </div>
    </div>
</section>
<!-- JS SCRIPT BLOCK START -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script>
console.log('BookRide page JS loaded');

// Utility: show alert in alert-container
function showAlert(message, type = 'info') {
    const alertContainer = document.getElementById('alert-container');
    alertContainer.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
    setTimeout(() => { alertContainer.innerHTML = ''; }, 5000);
}

// Load trips and populate trip dropdown
async function loadTrips() {
    const tripSelect = document.getElementById('tripId');
    tripSelect.innerHTML = '<option value="">Loading trips...</option>';
    try {
        const response = await fetch('/BookingData/GetTrips');
        const result = await response.json();
        console.log('Trips API result:', result);
        if (result.success && Array.isArray(result.data) && result.data.length > 0) {
            tripSelect.innerHTML = '<option value="">Choose a trip...</option>';
            result.data.forEach(trip => {
                const option = document.createElement('option');
                option.value = trip.tripId || trip.TripId;
                const departureTime = new Date(trip.departureTime || trip.DepartureTime).toLocaleString();
                const arrivalTime = new Date(trip.arrivalTime || trip.ArrivalTime).toLocaleString();
                option.textContent = `${trip.routeName || trip.RouteName} - ${departureTime} → ${arrivalTime}`;
                tripSelect.appendChild(option);
            });
        } else {
            tripSelect.innerHTML = '<option value="">No trips available</option>';
            showAlert('No trips found.', 'danger');
        }
    } catch (err) {
        console.error('Error loading trips:', err);
        tripSelect.innerHTML = '<option value="">Error loading trips</option>';
        showAlert('Error loading trips', 'danger');
    }
}

// Load seats for selected trip
async function loadSeats(tripId) {
    const seatSelect = document.getElementById('seatId');
    seatSelect.disabled = true;
    seatSelect.innerHTML = '<option value="">Loading seats...</option>';
    try {
        const response = await fetch(`/BookingData/GetSeats?tripId=${tripId}`);
        const result = await response.json();
        console.log('Seats API result:', result);
        if (result.success && Array.isArray(result.data) && result.data.length > 0) {
            seatSelect.innerHTML = '<option value="">Choose a seat...</option>';
            result.data.forEach(seat => {
                const option = document.createElement('option');
                option.value = seat.seatId || seat.SeatId;
                option.textContent = `Seat ${seat.seatNumber || seat.SeatNumber} - ${seat.seatType || seat.SeatType}`;
                seatSelect.appendChild(option);
            });
            seatSelect.disabled = false;
        } else {
            seatSelect.innerHTML = '<option value="">No seats available</option>';
            showAlert('No seats found for this trip.', 'danger');
        }
    } catch (err) {
        console.error('Error loading seats:', err);
        seatSelect.innerHTML = '<option value="">Error loading seats</option>';
        showAlert('Error loading seats', 'danger');
    }
}

// Handle booking form submission
async function submitBookingForm(event) {
    event.preventDefault();
    const submitBtn = document.getElementById('submitBtn');
    submitBtn.disabled = true;
    submitBtn.querySelector('.btn-text').textContent = 'Booking...';
    showAlert('Processing your booking...', 'info');

    // Gather form data
    const form = event.target;
    const data = {
        tripId: parseInt(form.tripId.value),
        seatId: parseInt(form.seatId.value),
        passengerName: form.passengerName.value.trim(),
        passengerPhone: form.passengerPhone.value.trim(),
        passengerEmail: form.passengerEmail.value.trim(),
        passengerIdCard: form.passengerIdCard.value.trim(),
        passengerDateOfBirth: form.passengerDateOfBirth.value ? form.passengerDateOfBirth.value : null,
        contactName: form.contactName.value.trim(),
        contactPhone: form.contactPhone.value.trim(),
        contactEmail: form.contactEmail.value.trim(),
        userId: null // Always guest booking from this form
    };

    // Remove empty contact fields for guest booking
    if (!data.contactName) delete data.contactName;
    if (!data.contactPhone) delete data.contactPhone;
    if (!data.contactEmail) delete data.contactEmail;
    if (!data.passengerIdCard) delete data.passengerIdCard;
    if (!data.passengerDateOfBirth) delete data.passengerDateOfBirth;

    try {
        const response = await fetch('/BookingData/CreateBooking', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        const result = await response.json();
        console.log('Booking API result:', result);
        if (result.success) {
            showAlert('Booking successful!', 'success');
            showBookingResult(result.data);
        } else {
            showAlert(result.message || 'Booking failed', 'danger');
        }
    } catch (err) {
        console.error('Error booking:', err);
        showAlert('Error booking ticket', 'danger');
    } finally {
        submitBtn.disabled = false;
        submitBtn.querySelector('.btn-text').textContent = 'Book Ticket Now';
    }
}

// Show booking result and QR code
function showBookingResult(data) {
    const bookingResult = document.getElementById('bookingResult');
    const bookingCode = document.getElementById('bookingCode');
    const qrCodeImage = document.getElementById('qrCodeImage');
    const qrCodeDiv = document.getElementById('qrCode');
    const bookingDetails = document.getElementById('bookingDetails');

    bookingResult.classList.add('show');
    bookingCode.textContent = data.ticketCode;

    // Generate QR code
    qrCodeDiv.innerHTML = '';
    const qr = new QRCode(qrCodeDiv, {
        text: data.ticketCode,
        width: 180,
        height: 180
    });

    // Fill booking details
    bookingDetails.innerHTML = `
        <div class="detail-item"><div class="detail-label">Passenger</div><div class="detail-value">${data.passengerName}</div></div>
        <div class="detail-item"><div class="detail-label">Phone</div><div class="detail-value">${data.passengerPhone}</div></div>
        <div class="detail-item"><div class="detail-label">Email</div><div class="detail-value">${data.passengerEmail}</div></div>
        <div class="detail-item"><div class="detail-label">Trip</div><div class="detail-value">${data.tripCode || ''}</div></div>
        <div class="detail-item"><div class="detail-label">Seat</div><div class="detail-value">${data.seatNumber || ''}</div></div>
        <div class="detail-item"><div class="detail-label">Carriage</div><div class="detail-value">${data.carriageNumber || ''}</div></div>
        <div class="detail-item"><div class="detail-label">Departure</div><div class="detail-value">${data.departureStation || ''} (${data.departureTime ? new Date(data.departureTime).toLocaleString() : ''})</div></div>
        <div class="detail-item"><div class="detail-label">Arrival</div><div class="detail-value">${data.arrivalStation || ''} (${data.arrivalTime ? new Date(data.arrivalTime).toLocaleString() : ''})</div></div>
        <div class="detail-item"><div class="detail-label">Total Price</div><div class="detail-value">${data.totalPrice || ''} VND</div></div>
    `;
}

// DOMContentLoaded: setup event listeners and load trips
window.addEventListener('DOMContentLoaded', function() {
    console.log('DOMContentLoaded');
    const tripSelect = document.getElementById('tripId');
    const seatSelect = document.getElementById('seatId');
    loadTrips();
    tripSelect.addEventListener('change', function() {
        const tripId = this.value;
        if (tripId) {
            loadSeats(tripId);
        } else {
            seatSelect.innerHTML = '<option value="">Choose a seat...</option>';
            seatSelect.disabled = true;
        }
    });
    document.getElementById('bookingForm').addEventListener('submit', submitBookingForm);
});
</script> 